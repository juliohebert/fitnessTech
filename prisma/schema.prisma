// Schema Prisma - FitnessTech (em Português)
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ===== AUTENTICAÇÃO E USUÁRIOS =====
model Usuario {
  id            String   @id @default(cuid())
  email         String   @unique
  senha         String
  nome          String
  funcao        String   @default("ALUNO") // ALUNO, PROFESSOR, NUTRI, ADMIN
  plano         String   @default("free") // free, pro, enterprise
  academiaId    String?
  telefone      String?
  cpf           String?
  imagemPerfil  String?
  ativo         Boolean  @default(true) // Se o usuário está ativo/aprovado
  aprovadoPor   String?  // ID do admin que aprovou
  
  // Dados biométricos básicos
  altura        String?  // em metros, ex: "1.82"
  peso          String?  // em kg, ex: "84.2"
  idade         String?  // idade em anos
  objetivo      String?  // objetivo do aluno: Hipertrofia, Cutting, Bulking, etc
  
  criadoEm      DateTime @default(now())
  atualizadoEm  DateTime @updatedAt
  
  // Relações
  academia              Academia?              @relation(fields: [academiaId], references: [id])
  historicoTreinos      HistoricoTreino[]
  fotosProgresso        FotoProgresso[]
  medicoesCorporais     MedicaoCorporal[]
  metas                 Meta[]
  conquistas            Conquista[]
  desafios              Desafio[]
  postagens             Postagem[]
  membrosGrupo          MembroGrupo[]
  rankings              Ranking[]
  anotacoesTreino       AnotacaoTreino[]
  previsoesIA           PrevisaoIA[]
  analisesRecuperacao   AnaliseRecuperacao[]
  relatorios            Relatorio[]
  notificacoes          Notificacao[]
  carrinho              ItemCarrinho[]
  videosExercicio       VideoExercicio[]
  badgesConquistados    BadgeConquistado[]
  sequencias            Sequencia[]
  
  // Relacionamento Professor/Nutri -> Alunos
  alunosComoProfessor   VinculoAlunoInstrutor[] @relation("Professor")
  professores           VinculoAlunoInstrutor[] @relation("Aluno")
  
  @@map("usuarios")
  @@index([email])
  @@index([academiaId])
  @@index([funcao])
}

// Tabela de vínculo entre Alunos e seus Professores/Nutricionistas
model VinculoAlunoInstrutor {
  id              String   @id @default(cuid())
  alunoId         String
  instrutorId     String
  tipoInstrutor   String   // "PROFESSOR" ou "NUTRI"
  ativo           Boolean  @default(true)
  criadoEm        DateTime @default(now())
  
  aluno           Usuario  @relation("Aluno", fields: [alunoId], references: [id], onDelete: Cascade)
  instrutor       Usuario  @relation(name: "Professor", fields: [instrutorId], references: [id], onDelete: Cascade)
  
  @@map("vinculos_aluno_instrutor")
  @@unique([alunoId, instrutorId, tipoInstrutor])
  @@index([alunoId])
  @@index([instrutorId])
}

model Academia {
  id              String   @id @default(cuid())
  nome            String
  plano           String   @default("free") // free, pro, enterprise
  maxUsuarios     Int      @default(10)
  usuariosAtuais  Int      @default(0)
  logo            String?
  ativa           Boolean  @default(true)
  criadoEm        DateTime @default(now())
  
  usuarios        Usuario[]
  
  @@map("academias")
}

// ===== TREINOS =====
model HistoricoTreino {
  id            String   @id @default(cuid())
  usuarioId     String
  tituloTreino  String
  exercicios    Json     // Array de exercícios com séries, reps, peso
  duracao       Int      // minutos
  calorias      Int
  data          DateTime @default(now())
  observacoes   String?
  
  usuario       Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  @@map("historico_treinos")
  @@index([usuarioId])
  @@index([data])
}

model AnotacaoTreino {
  id                String   @id @default(cuid())
  usuarioId         String
  tituloTreino      String
  tituloExercicio   String
  anotacao          String
  dataHora          DateTime @default(now())
  
  usuario           Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  @@map("anotacoes_treino")
  @@index([usuarioId])
}

model VideoExercicio {
  id                String   @id @default(cuid())
  usuarioId         String
  historicoTreinoId String?
  tituloExercicio   String
  urlVideo          String   // URL do vídeo (Cloudinary, S3, etc)
  urlThumbnail      String?  // Miniatura do vídeo
  duracao           Int?     // Duração em segundos
  tamanhoArquivo    Int?     // Tamanho em bytes
  status            String   @default("pendente") // pendente, aprovado, rejeitado
  feedbackInstrutor String?  // Feedback do instrutor
  avaliadoEm        DateTime?
  avaliadoPor       String?  // ID do instrutor
  criadoEm          DateTime @default(now())
  
  usuario           Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  @@map("videos_exercicio")
  @@index([usuarioId])
  @@index([status])
  @@index([criadoEm])
}

// ===== PROGRESSO FÍSICO =====
model FotoProgresso {
  id            String   @id @default(cuid())
  usuarioId     String
  urlImagem     String
  data          DateTime @default(now())
  peso          Float?
  observacoes   String?
  
  usuario       Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  @@map("fotos_progresso")
  @@index([usuarioId])
  @@index([data])
}

model MedicaoCorporal {
  id              String   @id @default(cuid())
  usuarioId       String
  peso            Float
  altura          Float?
  imc             Float?
  gorduraCorporal Float?
  massaMuscular   Float?
  peito           Float?
  cintura         Float?
  quadril         Float?
  biceps          Float?
  coxa            Float?
  panturrilha     Float?
  data            DateTime @default(now())
  
  usuario         Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  @@map("medicoes_corporais")
  @@index([usuarioId])
  @@index([data])
}

// ===== METAS E CONQUISTAS =====
model Meta {
  id            String   @id @default(cuid())
  usuarioId     String
  titulo        String
  descricao     String?
  valorAlvo     Float
  valorAtual    Float    @default(0)
  unidade       String   // kg, cm, %, treinos
  prazo         DateTime?
  completada    Boolean  @default(false)
  criadoEm      DateTime @default(now())
  atualizadoEm  DateTime @updatedAt
  
  usuario       Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  @@map("metas")
  @@index([usuarioId])
}

model Conquista {
  id            String   @id @default(cuid())
  usuarioId     String
  titulo        String
  descricao     String
  icone         String
  categoria     String   // treino, progresso, social, desafio
  desbloqueadoEm DateTime @default(now())
  
  usuario       Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  @@map("conquistas")
  @@index([usuarioId])
}

// ===== GAMIFICAÇÃO =====
model Desafio {
  id            String   @id @default(cuid())
  usuarioId     String
  titulo        String
  descricao     String
  tipo          String   // diario, semanal, mensal
  alvo          Int
  progresso     Int      @default(0)
  completado    Boolean  @default(false)
  dataInicio    DateTime @default(now())
  dataFim       DateTime
  recompensa    String?  // pontos, conquista, etc
  
  usuario       Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  @@map("desafios")
  @@index([usuarioId])
  @@index([dataFim])
}

model Ranking {
  id            String   @id @default(cuid())
  usuarioId     String
  pontos        Int      @default(0)
  nivel         Int      @default(1)
  sequencia     Int      @default(0) // dias consecutivos
  posicao       Int?
  atualizadoEm  DateTime @updatedAt
  
  usuario       Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  @@unique([usuarioId])
  @@map("rankings")
  @@index([pontos])
  @@index([nivel])
}

// ===== SOCIAL =====
model Postagem {
  id            String   @id @default(cuid())
  usuarioId     String
  conteudo      String
  urlImagem     String?
  curtidas      Int      @default(0)
  comentarios   Int      @default(0)
  criadoEm      DateTime @default(now())
  
  usuario       Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  @@map("postagens")
  @@index([usuarioId])
  @@index([criadoEm])
}

model Grupo {
  id            String   @id @default(cuid())
  nome          String
  descricao     String
  categoria     String
  totalMembros  Int      @default(0)
  imagem        String?
  criadoEm      DateTime @default(now())
  
  membros       MembroGrupo[]
  
  @@map("grupos")
}

model MembroGrupo {
  id            String   @id @default(cuid())
  grupoId       String
  usuarioId     String
  funcao        String   @default("membro") // membro, admin
  entradoEm     DateTime @default(now())
  
  grupo         Grupo    @relation(fields: [grupoId], references: [id], onDelete: Cascade)
  usuario       Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  @@unique([grupoId, usuarioId])
  @@map("membros_grupo")
  @@index([usuarioId])
  @@index([grupoId])
}

// ===== IA E ANÁLISES =====
model PrevisaoIA {
  id            String   @id @default(cuid())
  usuarioId     String
  tipo          String   // desempenho, peso, forca
  previsao      Json     // Dados da previsão
  confianca     Float    // 0-1
  criadoEm      DateTime @default(now())
  
  usuario       Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  @@map("previsoes_ia")
  @@index([usuarioId])
  @@index([tipo])
}

model AnaliseRecuperacao {
  id              String   @id @default(cuid())
  usuarioId       String
  horasSono       Float?
  nivelEstresse   Int?     // 1-10
  doresMuscular   Int?     // 1-10
  prontidao       String   // otima, boa, regular, ruim
  recomendacoes   Json
  data            DateTime @default(now())
  
  usuario         Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  @@map("analises_recuperacao")
  @@index([usuarioId])
  @@index([data])
}

model Relatorio {
  id            String   @id @default(cuid())
  usuarioId     String
  tipo          String   // mensal, trimestral, anual
  periodo       String   // "Jan 2024"
  dados         Json     // Estatísticas e gráficos
  criadoEm      DateTime @default(now())
  
  usuario       Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  @@map("relatorios")
  @@index([usuarioId])
  @@index([tipo])
}

// ===== NOTIFICAÇÕES =====
model Notificacao {
  id            String   @id @default(cuid())
  usuarioId     String
  titulo        String
  mensagem      String
  tipo          String   // info, sucesso, aviso, conquista
  lida          Boolean  @default(false)
  criadoEm      DateTime @default(now())
  
  usuario       Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  @@map("notificacoes")
  @@index([usuarioId])
  @@index([lida])
}

// ===== E-COMMERCE =====
model ItemCarrinho {
  id            String   @id @default(cuid())
  usuarioId     String
  produtoId     String
  nomeProduto   String
  preco         Float
  quantidade    Int      @default(1)
  urlImagem     String?
  adicionadoEm  DateTime @default(now())
  
  usuario       Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  @@map("itens_carrinho")
  @@index([usuarioId])
}

// ===== MÓDULO ADMINISTRATIVO =====

// CRM - Gerenciamento de Leads
model Lead {
  id          String   @id @default(cuid())
  academiaId  String
  nome        String
  telefone    String
  email       String?
  origem      String   @default("site") // instagram, facebook, site, indicacao
  status      String   @default("lead") // lead, contact, won, lost
  valorEstimado String @default("R$ 150/mês")
  observacoes String?
  criadoEm    DateTime @default(now())
  atualizadoEm DateTime @updatedAt
  
  @@map("leads")
  @@index([academiaId])
  @@index([status])
}

// Manutenção de Equipamentos
model TicketManutencao {
  id          String   @id @default(cuid())
  academiaId  String
  equipamento String
  descricao   String
  prioridade  String   @default("MEDIUM") // LOW, MEDIUM, HIGH
  status      String   @default("OPEN") // OPEN, PENDING, FIXED
  criadoPor   String?  // ID do usuário que criou
  resolvido   DateTime?
  criadoEm    DateTime @default(now())
  atualizadoEm DateTime @updatedAt
  
  @@map("tickets_manutencao")
  @@index([academiaId])
  @@index([status])
}

// Produtos da Loja
model Produto {
  id          String   @id @default(cuid())
  academiaId  String
  nome        String
  categoria   String   // suplementos, equipamentos, acessorios
  preco       Float
  estoque     Int      @default(0)
  estoqueMinimo Int    @default(10)
  descricao   String?
  urlImagem   String?
  ativo       Boolean  @default(true)
  criadoEm    DateTime @default(now())
  atualizadoEm DateTime @updatedAt
  
  vendas      VendaProduto[]
  
  @@map("produtos")
  @@index([academiaId])
  @@index([categoria])
  @@index([ativo])
}

// Vendas de Produtos
model VendaProduto {
  id          String   @id @default(cuid())
  produtoId   String
  academiaId  String
  usuarioId   String?  // Cliente que comprou
  quantidade  Int
  precoUnitario Float
  precoTotal  Float
  dataVenda   DateTime @default(now())
  
  produto     Produto  @relation(fields: [produtoId], references: [id])
  
  @@map("vendas_produtos")
  @@index([academiaId])
  @@index([dataVenda])
  @@index([produtoId])
}

// Funcionários
model Funcionario {
  id          String   @id @default(cuid())
  academiaId  String
  nome        String
  cargo       String   // Professor, Nutricionista, Recepcao, Gerente
  salario     Float
  telefone    String?
  email       String?
  dataAdmissao DateTime @default(now())
  ativo       Boolean  @default(true)
  performance Int      @default(85) // Pontuação de 0-100
  
  @@map("funcionarios")
  @@index([academiaId])
  @@index([ativo])
}

// Relatórios Financeiros
model RelatorioFinanceiro {
  id          String   @id @default(cuid())
  academiaId  String
  mes         Int      // 1-12
  ano         Int
  receita     Float    @default(0)
  despesas    Float    @default(0)
  lucro       Float    @default(0)
  inadimplencia Float  @default(0)
  criadoEm    DateTime @default(now())
  
  @@map("relatorios_financeiros")
  @@index([academiaId])
  @@index([ano, mes])
  @@unique([academiaId, ano, mes])
}

// Dados de Acesso (para gráficos)
model RegistroAcesso {
  id          String   @id @default(cuid())
  academiaId  String
  nomeAluno   String
  hora        String   // "06:30", "07:15", etc
  data        DateTime @default(now())
  criadoEm    DateTime @default(now())
  
  @@map("registros_acesso")
  @@index([academiaId])
  @@index([data])
}

// Agendamentos de Atendimento
model Agendamento {
  id          String   @id @default(cuid())
  instrutorId String   // Professor ou Nutricionista
  alunoId     String   // Aluno que será atendido
  data        DateTime
  hora        String   // "14:00", "16:30"
  tipo        String   // "Personal Training", "Avaliação Física", "Consulta Nutricional"
  status      String   @default("pending") // pending, confirmed, completed, cancelled
  observacoes String?
  criadoEm    DateTime @default(now())
  atualizadoEm DateTime @updatedAt
  
  @@map("agendamentos")
  @@index([instrutorId])
  @@index([alunoId])
  @@index([data])
  @@index([status])
}

// ===== NUTRIÇÃO =====

// Diário Alimentar Visual
model RefeicaoDiario {
  id            String   @id @default(cuid())
  usuarioId     String   // Aluno que registrou a refeição
  tipoRefeicao  String   // "Café da Manhã", "Almoço", "Jantar", "Lanche"
  urlImagem     String   // URL da foto da refeição
  horario       String   // Horário da refeição "08:15"
  data          DateTime @default(now())
  status        String   @default("pending") // pending, approved, warning, rejected
  feedback      String?  // Feedback do nutricionista
  avaliadoPor   String?  // ID do nutricionista que avaliou
  avaliadoEm    DateTime?
  calorias      Int?     // Estimativa de calorias
  observacoes   String?
  
  @@map("refeicoes_diario")
  @@index([usuarioId])
  @@index([data])
  @@index([status])
}

// Análise de Composição Corporal (extende MedicaoCorporal)
model AnaliseComposicao {
  id                String   @id @default(cuid())
  usuarioId         String
  peso              Float
  percentualGordura Float?
  massaMuscular     Float?
  aguaCorporal      Float?
  taxaMetabolica    Float?   // Taxa metabólica basal
  idadeMetabolica   Int?     // Idade metabólica
  gorduraVisceral   Int?     // Nível de gordura visceral (1-59)
  observacoes       String?
  avaliadoPor       String?  // ID do nutricionista
  data              DateTime @default(now())
  
  @@map("analises_composicao")
  @@index([usuarioId])
  @@index([data])
}

// Conteúdo Educacional Nutricional
model ConteudoEducacional {
  id          String   @id @default(cuid())
  titulo      String
  descricao   String?
  categoria   String   // "Nutrição", "Performance", "Básico", "Receita", "Guia"
  tipo        String   // "Artigo", "Vídeo", "Infográfico", "Receita", "Guia"
  duracao     String?  // "5 min", "10 páginas", etc
  urlConteudo String?  // URL do conteúdo (vídeo, PDF, etc)
  conteudo    String?  @db.Text // Conteúdo textual
  urlImagem   String?  // Imagem de capa
  publicadoPor String  // ID do nutricionista autor
  publicado   Boolean  @default(false)
  visualizacoes Int    @default(0)
  criadoEm    DateTime @default(now())
  atualizadoEm DateTime @updatedAt
  
  @@map("conteudos_educacionais")
  @@index([categoria])
  @@index([tipo])
  @@index([publicado])
}

// Badges e Conquistas
model Badge {
  id          String   @id @default(cuid())
  nome        String
  descricao   String
  icone       String   // nome do ícone
  tipo        String   // TREINO, CARDIO, PESO, META, SEQUENCIA
  criterio    String   // descrição do critério para desbloquear
  valor       Float?   // valor necessário (ex: 100 para 100kg)
  criadoEm    DateTime @default(now())
  
  conquistas  BadgeConquistado[]
  
  @@map("badges")
  @@index([tipo])
}

model BadgeConquistado {
  id          String   @id @default(cuid())
  usuarioId   String
  badgeId     String
  progresso   Float    @default(0) // % de conclusão
  conquistado Boolean  @default(false)
  conquistadoEm DateTime?
  criadoEm    DateTime @default(now())
  
  usuario     Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  badge       Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  
  @@unique([usuarioId, badgeId])
  @@map("badges_conquistados")
  @@index([usuarioId])
  @@index([conquistado])
}

// Sequências (Streaks)
model Sequencia {
  id          String   @id @default(cuid())
  usuarioId   String
  tipo        String   // TREINO, CARDIO, META_CALORICA, PESO
  atual       Int      @default(0)
  melhor      Int      @default(0)
  ultimaData  DateTime @default(now())
  criadoEm    DateTime @default(now())
  atualizadoEm DateTime @updatedAt
  
  usuario     Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  @@unique([usuarioId, tipo])
  @@map("sequencias")
  @@index([usuarioId])
}

// Pagamentos e Mensalidades
model Pagamento {
  id            String   @id @default(cuid())
  usuarioId     String
  valor         Float
  mesReferencia String   // "2025-01" formato YYYY-MM
  status        String   @default("PENDENTE") // PENDENTE, PAGO, ATRASADO, CANCELADO
  metodoPagamento String? // PIX, CARTAO, DINHEIRO, TRANSFERENCIA
  dataVencimento DateTime
  dataPagamento DateTime?
  observacoes   String?
  criadoPor     String   // ID do admin que criou
  criadoEm      DateTime @default(now())
  atualizadoEm  DateTime @updatedAt
  
  @@map("pagamentos")
  @@index([usuarioId])
  @@index([mesReferencia])
  @@index([status])
  @@index([dataVencimento])
}
